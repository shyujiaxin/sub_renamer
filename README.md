# 字幕文件重命名工具 (sub_renamer)

## 简介

这是一个用于自动重命名 ASS 字幕文件的工具。它能够将 ASS 字幕文件重命名为与同目录下对应的 MKV 视频文件同名，通过匹配文件名的季集格式（SxxEyy）来建立文件之间的对应关系。

## 功能特点

- 支持多种季集格式：`SxxEyy`、`Sxx-Eyy`、`Sxx_Eyy`、`Sxx.Eyy`、`SxxEyy-Ezz` 等
- 自动跳过隐藏目录（以 `.` 开头的目录）
- 提供详细的操作日志和统计信息
- 智能处理文件冲突和错误情况
- 递归遍历子目录，支持批量处理

## 使用方法

### 基本使用

在脚本所在目录运行：

```bash
python sub_renamer.py
```

默认会在当前目录（`.`）执行重命名操作。

### 自定义目录

修改 `main()` 函数中的 `root_directory` 变量：

```python
def main():
    root_directory = "/path/to/your/videos"  # 修改为你的目录路径
    rename_ass_to_match_mkv(root_directory)
```

## 典型场景示例

### 场景 1：标准格式匹配

**处理前的文件结构：**

```
Season1/
├── Show.Name.S01E01.1080p.mkv
├── Show.Name.S01E01.1080p.ass
├── Show.Name.S01E02.1080p.mkv
└── Show.Name.S01E02.1080p.ass
```

**处理后的结果：**

```
Season1/
├── Show.Name.S01E01.1080p.mkv
├── Show.Name.S01E01.1080p.ass  ✅ 已匹配
├── Show.Name.S01E02.1080p.mkv
└── Show.Name.S01E02.1080p.ass  ✅ 已匹配
```

**说明：** ASS 文件已与对应的 MKV 文件同名，无需重命名。

### 场景 2：字幕文件名格式不同

**处理前的文件结构：**

```
Season2/
├── Show.Name.S02E01.1080p.mkv
├── subtitle_s02e01.ass          ← 需要重命名
├── Show.Name.S02E02.1080p.mkv
└── s02.e02.cht.ass                ← 需要重命名
```

**处理后的结果：**

```
Season2/
├── Show.Name.S02E01.1080p.mkv
├── Show.Name.S02E01.1080p.ass  ✅ 已重命名
├── Show.Name.S02E02.1080p.mkv
└── Show.Name.S02E02.1080p.ass  ✅ 已重命名
```

**说明：** 只要字幕文件名中包含 `S02E01`、`S02-E01`、`S02.E01` 或 `s02e01` 等格式（必须同时包含季号 S 和集号 E），工具就能识别并重命名。注意：仅包含集号（如 `ep02`）而没有季号的格式无法被识别。

### 场景 3：连集格式（双集）

**处理前的文件结构：**

```
Season3/
├── Show.Name.S03E01-E02.1080p.mkv
├── s03e01-e02.ass                ← 需要重命名
└── Show.Name.S03E03.1080p.mkv
```

**处理后的结果：**

```
Season3/
├── Show.Name.S03E01-E02.1080p.mkv
├── Show.Name.S03E01-E02.1080p.ass  ✅ 已重命名
└── Show.Name.S03E03.1080p.mkv
```

**说明：** 支持连集格式（如 `S03E01-E02`），工具会正确识别并匹配。

### 场景 4：不同分隔符格式

**处理前的文件结构：**

```
Season4/
├── Show.Name.S04E01_1080p.mkv
├── Show.Name.S04-E01.ass         ← 需要重命名
├── Show.Name.S04E02.1080p.mkv
└── Show.Name.S04.E02.ass          ← 需要重命名
```

**处理后的结果：**

```
Season4/
├── Show.Name.S04E01_1080p.mkv
├── Show.Name.S04E01_1080p.ass  ✅ 已重命名
├── Show.Name.S04E02.1080p.mkv
└── Show.Name.S04E02.1080p.ass  ✅ 已重命名
```

**说明：** 工具支持多种分隔符（`-`、`_`、`.`），会自动匹配并统一为 MKV 文件的格式。

### 场景 5：多层目录结构

**处理前的文件结构：**

```
TV Series/
├── Season 1/
│   ├── S01E01.mkv
│   ├── subtitle_s01e01.ass      ← 需要重命名
│   ├── S01E02.mkv
│   └── subtitle_s01e02.ass      ← 需要重命名
└── Season 2/
    ├── S02E01.mkv
    └── subtitle_s02e01.ass      ← 需要重命名
```

**处理后的结果：**

```
TV Series/
├── Season 1/
│   ├── S01E01.mkv
│   ├── S01E01.ass               ✅ 已重命名
│   ├── S01E02.mkv
│   └── S01E02.ass               ✅ 已重命名
└── Season 2/
    ├── S02E01.mkv
    └── S02E01.ass               ✅ 已重命名
```

**说明：** 工具会递归遍历所有子目录，自动处理每个目录下的文件。

### 场景 6：部分文件无法匹配

**处理前的文件结构：**

```
Season5/
├── Show.Name.S05E01.1080p.mkv
├── Show.Name.S05E01.1080p.ass
├── Show.Name.S05E02.1080p.mkv
├── old_subtitle.ass              ← 无法匹配（无季集格式）
└── Show.Name.S05E03.1080p.ass   ← 无法匹配（无对应 MKV）
```

**处理后的结果：**

```
Season5/
├── Show.Name.S05E01.1080p.mkv
├── Show.Name.S05E01.1080p.ass  ✅ 已符合
├── Show.Name.S05E02.1080p.mkv
├── old_subtitle.ass             ⚠️ 跳过（未匹配到 SxxEyy 格式）
└── Show.Name.S05E03.1080p.ass  ⚠️ 跳过（未找到匹配的 MKV 文件）
```

**说明：**

- 文件名中不包含季集格式的字幕文件会被跳过（如 `old_subtitle.ass`、`ep02.ass` 等）
- 文件名中只有集号而没有季号的字幕文件也无法被识别（如 `ep02.ass`、`E02.ass` 等，必须同时包含 `Sxx` 和 `Eyy`）
- 没有对应 MKV 文件的字幕文件也会被跳过

### 场景 7：文件名冲突处理

**处理前的文件结构：**

```
Season6/
├── Show.Name.S06E01.1080p.mkv
├── subtitle_s06e01.ass          ← 需要重命名
└── Show.Name.S06E01.1080p.ass   ← 目标文件已存在
```

**处理后的结果：**

```
Season6/
├── Show.Name.S06E01.1080p.mkv
├── subtitle_s06e01.ass          ⚠️ 跳过（目标文件已存在）
└── Show.Name.S06E01.1080p.ass   ✅ 保持不变
```

**说明：** 如果目标文件名已存在，工具会跳过重命名操作，避免覆盖现有文件。

## 运行输出示例

```
--- 调试信息：正则表达式 ---
使用的正则: [Ss](\d+)[-_\.]?[Ee](\d+)([-_\.]?[Ee]\d+)?
----------------------------
开始遍历目录: . (当前执行路径)
------------------------------------------------------------

当前目录: ./Season1
  包含文件数: 4
  MKV基准名数量: 2
  [ASS符合] 文件: Show.Name.S01E01.1080p.ass - 已符合 MKV 原始文件名，跳过。
  [ASS成功] subtitle_s01e02.ass -> Show.Name.S01E02.1080p.ass (匹配到 MKV 基准: S01E02)

============================================================
所有文件重命名操作完成。
    - 总重命名 ASS 文件数: 1
    - 总错误/警告数: 0
============================================================
```

## 注意事项

1. **备份重要文件**：虽然工具会检查文件冲突，但建议在处理大量文件前先备份重要数据。

2. **文件格式要求**：
   - 视频文件必须是 `.mkv` 格式
   - 字幕文件必须是 `.ass` 格式
   - 文件名中必须包含季集格式（如 `S01E01`），**必须同时包含季号（S）和集号（E）**
   - 不支持仅包含集号的格式（如 `ep02`、`E02` 等）

3. **匹配规则**：
   - 工具通过匹配季集格式来建立文件对应关系
   - 季集格式必须同时包含 `Sxx`（季号）和 `Eyy`（集号），支持的分隔符包括：`-`、`_`、`.` 或无分隔符
   - 同一目录下的 MKV 和 ASS 文件才会被匹配
   - 如果多个 MKV 文件匹配到相同的基准键，会显示警告但继续处理

4. **隐藏目录**：
   - 以 `.` 开头的目录会被自动跳过（如 `.git`、`.vscode` 等）

5. **错误处理**：
   - 如果文件重命名失败（如权限不足），会显示错误信息并继续处理其他文件
   - 最终会统计所有成功和失败的次数

## 技术实现

- 使用正则表达式匹配季集格式
- 递归遍历目录结构
- 智能文件映射和冲突检测
- 详细的日志输出和错误处理

## 许可证

请查看项目根目录的 LICENSE 文件。
